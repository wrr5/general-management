<!DOCTYPE html>
<html>
<head>
    <title>å‘è´§ä¿¡æ¯æŸ¥è¯¢</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <style>
        .container {
            max-width: 1200px;
            margin-top: 30px;
        }
        .section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .section-title {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0d6efd;
        }
        .order-card {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .order-header {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            margin-bottom: 10px;
        }
        .status-badge {
            font-size: 0.85em;
            padding: 3px 8px;
        }
        .tracking-link {
            color: #0d6efd;
            cursor: pointer;
            text-decoration: none;
            border-bottom: 1px dashed #0d6efd;
            margin-right: 5px;
        }
        .tracking-link:hover {
            color: #0a58ca;
            text-decoration: none;
        }
        .modal-lg {
            max-width: 900px;
        }
        .timeline {
            position: relative;
            padding-left: 30px;
            margin-top: 20px;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        .timeline-item:before {
            content: '';
            position: absolute;
            left: -22px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #0d6efd;
            border: 2px solid white;
            z-index: 2;
        }
        .timeline-item:after {
            content: '';
            position: absolute;
            left: -16px;
            top: 17px;
            bottom: -25px;
            width: 2px;
            background-color: #dee2e6;
            z-index: 1;
        }
        .timeline-item:last-child:after {
            display: none;
        }
        .timeline-content {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 3px solid #0d6efd;
        }
        .timeline-time {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }
        .timeline-status {
            font-weight: bold;
            color: #0d6efd;
            margin-bottom: 5px;
        }
        .modal-tracking-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">å‘è´§ä¿¡æ¯æŸ¥è¯¢</h1>
        
        <!-- æ‰‹æœºå·æŸ¥è¯¢åŒº -->
        <div class="section">
            <h3 class="section-title">ğŸ“± æ‰‹æœºå·æŸ¥è¯¢å‘è´§ä¿¡æ¯</h3>
            
            <form action="/api/delivery/query/byphone" method="get" class="row g-3 mb-4">
                <div class="col-md-8">
                    <input type="text" 
                           name="phone" 
                           class="form-control" 
                           placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " 
                           value="{{.phone}}"
                           required>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">æŸ¥è¯¢</button>
                </div>
            </form>
            
            {{if .success}}
                {{if eq .count 0}}
                    <div class="alert alert-warning">
                        æœªæ‰¾åˆ°æ‰‹æœºå·ä¸º <strong>{{.phone}}</strong> çš„å‘è´§ä¿¡æ¯
                    </div>
                {{else}}
                    <div class="alert alert-success">
                        æ‰¾åˆ° <strong>{{.count}}</strong> æ¡æ‰‹æœºå·ä¸º <strong>{{.phone}}</strong> çš„å‘è´§ä¿¡æ¯
                    </div>
                    
                    <!-- è®¢å•åˆ—è¡¨ -->
                    {{range .orders}}
                    <div class="order-card">
                        <div class="order-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">å‘è´§å•å·: {{.DeliveryOrderNo}}</h5>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>é—¨åº—åç§°:</strong> {{.StoreName}}</p>
                                <p><strong>æ”¶è´§äºº:</strong> {{.Receiver}} / {{.Phone}}</p>
                                <p><strong>æ”¶è´§åœ°å€:</strong> {{.Address}}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>å•†å“åç§°:</strong> {{.ProductName}}</p>
                                <p><strong>ç‰©æµå•å·:</strong> 
                                    {{if .TrackingNumber}}
                                        {{$trackingNumbers := splitTrackingNumber .TrackingNumber}}
                                        {{range $index, $number := $trackingNumbers}}
                                            <a href="javascript:void(0);" 
                                               class="tracking-link" 
                                               onclick="queryTracking('{{$number}}')">{{$number}}</a>
                                            {{if lt $index (sub (len $trackingNumbers) 1)}}/{{end}}
                                        {{end}}
                                    {{else}}
                                        <span class="text-muted">æš‚æ— </span>
                                    {{end}}
                                </p>
                            </div>
                        </div>
                    </div>
                    {{end}}
                {{end}}
            {{else if .error}}
                <div class="alert alert-danger">
                    {{.error}}
                </div>
            {{end}}
        </div>
        
        <!-- æ–‡ä»¶ä¸Šä¼ åŒº -->
        <div class="section">
            <h3 class="section-title">ğŸ“¤ ä¸Šä¼ å‘è´§å•Excelæ–‡ä»¶</h3>
            
            <form id="uploadForm" action="/api/delivery/upload/delivery" method="post" enctype="multipart/form-data">
                <div class="row g-3">
                    <div class="col-md-6">
                        <input type="file" 
                               name="file" 
                               class="form-control" 
                               accept=".xlsx,.xls" 
                               required>
                        <div class="form-text">æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼çš„Excelæ–‡ä»¶</div>
                    </div>
                    <div class="col-md-6">
                        <button type="submit" class="btn btn-success w-100">ä¸Šä¼ å‘è´§å•</button>
                    </div>
                </div>
            </form>
            
            <div id="uploadResult" class="mt-3"></div>
        </div>
    </div>

    <!-- ç‰©æµè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="trackingModal" tabindex="-1" aria-labelledby="trackingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="trackingModalLabel">ç‰©æµè¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="trackingContent">
                        <!-- ç‰©æµä¿¡æ¯å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¾…åŠ©å‡½æ•°ï¼šåˆ†å‰²ç‰©æµå•å·ï¼ˆå¤„ç†å¤šä¸ªå•å·ç”¨/åˆ†éš”çš„æƒ…å†µï¼‰
        function splitTrackingNumber(trackingNumber) {
            if (!trackingNumber) return [];
            return trackingNumber.split('/').map(num => num.trim()).filter(num => num);
        }

        // æŸ¥è¯¢ç‰©æµä¿¡æ¯
        async function queryTracking(trackingNumber) {
            const modal = new bootstrap.Modal(document.getElementById('trackingModal'));
            const contentDiv = document.getElementById('trackingContent');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            contentDiv.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-3">æ­£åœ¨æŸ¥è¯¢ç‰©æµä¿¡æ¯: ${trackingNumber}</p>
                </div>
            `;
            
            modal.show();
            
            try {
                const response = await fetch('http://38.246.250.140:8080/api/delivery/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tracking_numbers: trackingNumber
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    renderTrackingResult(result.data[0]);
                } else {
                    contentDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>æŸ¥è¯¢å¤±è´¥</h6>
                            <p>å•å·: ${trackingNumber}</p>
                            <p>é”™è¯¯: ${result.error || 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>ç½‘ç»œé”™è¯¯</h6>
                        <p>å•å·: ${trackingNumber}</p>
                        <p>é”™è¯¯: ${error.message}</p>
                    </div>
                `;
            }
        }

        const expressCompanyMap = {
            'STO': 'ç”³é€šå¿«é€’',
            'SF': 'é¡ºä¸°é€Ÿè¿',
            'YT': 'åœ†é€šé€Ÿé€’',
            'YD': 'éŸµè¾¾å¿«é€’',
            'ZT': 'ä¸­é€šå¿«é€’',
            'YZPY': 'é‚®æ”¿å¿«é€’åŒ…è£¹',
            'JD': 'äº¬ä¸œç‰©æµ',
            'TTKDEX': 'å¤©å¤©å¿«é€’',
            'UC': 'ä¼˜é€Ÿå¿«é€’',
            'DBL': 'å¾·é‚¦å¿«é€’',
            'FAST': 'å¿«æ·å¿«é€’',
            'ZTO': 'ä¸­é€šå¿«é€’',
            'EMS': 'EMS',
            'HHTT': 'å¤©å¤©å¿«é€’',
            'YMDD': 'å£¹ç±³æ»´ç­”',
            'ANE': 'å®‰èƒ½ç‰©æµ',
            'DEPPON': 'å¾·é‚¦å¿«é€’',
            'GTO': 'å›½é€šå¿«é€’',
            'JTSD': 'æå…”é€Ÿé€’',
            'QFKD': 'å…¨å³°å¿«é€’',
            'RRS': 'æ—¥æ—¥é¡ºç‰©æµ',
            'SURE': 'é€Ÿå°”å¿«é€’',
            'UAPEX': 'å…¨ä¸€å¿«é€’',
            'YUNDA': 'éŸµè¾¾å¿«é€’',
            'ZJS': 'å®…æ€¥é€'
        };
        function getExpressCompanyName(code) {
            return expressCompanyMap[code] || code;
        }

        // æ¸²æŸ“ç‰©æµç»“æœ
        function renderTrackingResult(data) {
            const contentDiv = document.getElementById('trackingContent');
            const companyName = getExpressCompanyName(data.shipperCode);
            // ç‰©æµåŸºæœ¬ä¿¡æ¯
            let html = `
                <div class="modal-tracking-info">
                    <h5>ç‰©æµä¿¡æ¯</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>å¿«é€’å…¬å¸:</strong> ${companyName}</p>
                            <p><strong>ç‰©æµå•å·:</strong> ${data.logisticCode}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>å½“å‰çŠ¶æ€:</strong> 
                                <span class="badge ${getStatusBadgeClass(data.state)}">
                                    ${data.stateText} (${data.stateExText})
                                </span>
                            </p>
                            <p><strong>å½“å‰ä½ç½®:</strong> ${data.location}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // ç‰©æµè½¨è¿¹æ—¶é—´çº¿
            if (data.traces && data.traces.length > 0) {
                html += `<h6 class="mb-3">ç‰©æµè½¨è¿¹</h6>`;
                html += `<div class="timeline">`;
                
                data.traces.forEach((trace, index) => {
                    html += `
                        <div class="timeline-item">
                            <div class="timeline-content">
                                <div class="timeline-time">
                                    <i class="far fa-clock me-1"></i>${trace.acceptTime}
                                </div>
                                <div class="timeline-status">
                                    ${trace.actionText || trace.stateText}
                                </div>
                                <div>${trace.acceptStation}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            } else {
                html += `<div class="alert alert-info">æš‚æ— ç‰©æµè½¨è¿¹ä¿¡æ¯</div>`;
            }
            
            contentDiv.innerHTML = html;
        }

        // æ ¹æ®çŠ¶æ€è·å–å¾½ç« ç±»å
        function getStatusBadgeClass(state) {
            switch(state) {
                case '1': // å·²æ½æ”¶
                    return 'bg-info';
                case '2': // åœ¨é€”ä¸­
                    return 'bg-primary';
                case '3': // ç­¾æ”¶
                    return 'bg-success';
                case '4': // é—®é¢˜ä»¶
                    return 'bg-danger';
                default:
                    return 'bg-secondary';
            }
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = this;
            const resultDiv = document.getElementById('uploadResult');
            const submitBtn = form.querySelector('button[type="submit"]');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'ä¸Šä¼ ä¸­...';
            submitBtn.disabled = true;
            resultDiv.innerHTML = '<div class="alert alert-info">æ–‡ä»¶ä¸Šä¼ ä¸­ï¼Œè¯·ç¨å€™...</div>';
            
            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>ä¸Šä¼ æˆåŠŸ!</strong><br>
                            ${result.message}<br>
                            å…±å¯¼å…¥ ${result.count || 0} æ¡æ•°æ®
                        </div>
                    `;
                    form.reset();
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>ä¸Šä¼ å¤±è´¥!</strong><br>
                            ${result.error || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>ä¸Šä¼ å¤±è´¥!</strong><br>
                        ${error.message}
                    </div>
                `;
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
    </script>
    
    <script src="/static/js/bootstrap.bundle.js"></script>
</body>
</html>